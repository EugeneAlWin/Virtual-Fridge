# Схема базы данных

[Ссылка на схему (тык)](https://dbdiagram.io/d/DIPLOMA-65342160ffbf5169f02c62cf)

| Таблица                                                                          | Поле                                            | Свойства (основные)                      | Пояснение к таблице                                                                                                                                                                                      |
| -------------------------------------------------------------------------------- | ----------------------------------------------- | ---------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **User**                                                                         | id                                              | <span style="color:lightgreen">PK</span> |                                                                                                                                                                                                          |
| Пользовательские данные                                                          | login                                           | varchar                                  |                                                                                                                                                                                                          |
|                                                                                  | password                                        | varchar                                  |                                                                                                                                                                                                          |
|                                                                                  | role                                            | Roles                                    | Роль пользователя (0)                                                                                                                                                                                    |
|                                                                                  | createdAt                                       | timestamp                                |                                                                                                                                                                                                          |
|                                                                                  | isFrozen                                        | bool                                     | Заархивирован ли пользователь (удален аккаунт)                                                                                                                                                           |
|                                                                                  | isBlocked                                       | bool                                     | Блокировка на добавление рецептов и продуктов (бан)                                                                                                                                                      |
| **UserToken**                                                                    | <span style="color:lightgreen">userId</span>    | CK, FK                                   |                                                                                                                                                                                                          |
| Дополнение к данным пользователя, вход с нескольких устройств                    | deviceId                                        | CK                                       |                                                                                                                                                                                                          |
|                                                                                  | refreshToken                                    | varchar                                  |                                                                                                                                                                                                          |
|                                                                                  | lastLoginAt                                     | timestamp                                |                                                                                                                                                                                                          |
| **Store**                                                                        | id                                              | <span style="color:red">PK</span>        |                                                                                                                                                                                                          |
| Холодильник пользователя                                                         | <span style="color:lightgreen">creatorId</span> | FK                                       |                                                                                                                                                                                                          |
|                                                                                  | title                                           | varchar                                  |                                                                                                                                                                                                          |
| **StoreComposition**                                                             | purchaseDate                                    | timestamp                                | Дата покупки                                                                                                                                                                                             |
| Информация о содержимом холодильника пользователя                                | expireDate                                      | timestamp, nullable                      | Срок годности продукта                                                                                                                                                                                   |
|                                                                                  | <span style="color:red">storeId</span>          | FK                                       |                                                                                                                                                                                                          |
|                                                                                  | <span style="color:pink">productId</span>       | FK                                       |                                                                                                                                                                                                          |
|                                                                                  | productQuantity                                 | int                                      | Количество продукта (размерность задается в продукте)                                                                                                                                                    |
| **Checklist**                                                                    | id                                              | <span style="color:orange">PK</span>     |                                                                                                                                                                                                          |
| Информация о списке покупок                                                      | <span style="color:lightgreen">creatorId</span> | FK                                       |                                                                                                                                                                                                          |
|                                                                                  | createdAt                                       | timestamp                                |                                                                                                                                                                                                          |
|                                                                                  | isConfirmed                                     | bool                                     | Совершена ли покупка\*                                                                                                                                                                                   |
|                                                                                  | lastUpdatedAt                                   | timestamp                                |                                                                                                                                                                                                          |
| **ChecklistComposition**                                                         | <span style="color:orange">checklistId</span>   | FK                                       |                                                                                                                                                                                                          |
| Состав списка                                                                    | <span style="color:pink">productId</span>       | FK                                       |                                                                                                                                                                                                          |
|                                                                                  | productQuantity                                 | int                                      | Количество продуктов                                                                                                                                                                                     |
|                                                                                  | price                                           | decimal                                  |                                                                                                                                                                                                          |
|                                                                                  | currency                                        | Currencies                               | Валюты (1)                                                                                                                                                                                               |
| **Product**                                                                      | id                                              | <span style="color:pink">PK</span>       |                                                                                                                                                                                                          |
| Информация о продукте                                                            | <span style="color:lightgreen">creatorId</span> | FK                                       |                                                                                                                                                                                                          |
|                                                                                  | title                                           | varchar                                  |                                                                                                                                                                                                          |
|                                                                                  | calories                                        | int                                      |                                                                                                                                                                                                          |
|                                                                                  | protein                                         | int                                      | Белки                                                                                                                                                                                                    |
|                                                                                  | fats                                            | int                                      | Жиры                                                                                                                                                                                                     |
|                                                                                  | carbohydrates                                   | int                                      | Углеводы                                                                                                                                                                                                 |
|                                                                                  | isOfficial                                      | bool                                     | Продукт подтвержден администраторами\*\*                                                                                                                                                                 |
|                                                                                  | isFrozen                                        | bool                                     | Мягкое удаление продукта. Продукт удаляется из базы, если нету ссылок. В противном случае помечается как удаленный и не предлагается в поиске, но на странице рецепта можно посмотреть информацию о нем. |
|                                                                                  | unit                                            | Units                                    | Единицы измерения (3)                                                                                                                                                                                    |
| **Recipe**                                                                       | id                                              | <span style="color:yellow">PK</span>     |                                                                                                                                                                                                          |
| Информация о рецепте                                                             | <span style="color:lightgreen">creatorId</span> | FK                                       |                                                                                                                                                                                                          |
|                                                                                  | title                                           | varchar                                  |                                                                                                                                                                                                          |
|                                                                                  | type                                            | RecipeType                               | Тип рецепта (2)                                                                                                                                                                                          |
|                                                                                  | description                                     | text                                     |                                                                                                                                                                                                          |
|                                                                                  | createdAt                                       | timestamp                                |                                                                                                                                                                                                          |
|                                                                                  | isPrivate                                       | bool                                     | Рецепт можно пометить как приватный и он перестанет отображаться в поиске. Однако пользователи, добавившие рецепт в избранное и др., по-прежнему смогут его видеть                                       |
|                                                                                  | isOfficial                                      | bool                                     | Официальный ли рецепт                                                                                                                                                                                    |
|                                                                                  | isFrozen                                        | bool                                     | Поведение аналогично Product.isFrozen                                                                                                                                                                    |
| **RecipeComposition**                                                            | <span style="color:yellow">recipeId</span>      | CK, FK                                   |                                                                                                                                                                                                          |
| Состав рецепта                                                                   | <span style="color:pink">productId</span>       | CK, FK                                   |                                                                                                                                                                                                          |
|                                                                                  | quantity                                        | int                                      | Количество продукта                                                                                                                                                                                      |
| **RecipeRating**                                                                 | <span style="color:yellow">recipeId</span>      | FK                                       | Рейтинг рецепта                                                                                                                                                                                          |
|                                                                                  | rating                                          | float                                    |                                                                                                                                                                                                          |
| **UserGrade**                                                                    | <span style="color:yellow">recipeId</span>      | CK, FK                                   |                                                                                                                                                                                                          |
| Информация об оценке рецепта пользователем                                       | <span style="color:lightgreen">userId</span>    | CK, FK                                   |                                                                                                                                                                                                          |
|                                                                                  | grade                                           | int                                      |                                                                                                                                                                                                          |
| **FavoriteRecipe**                                                               | <span style="color:lightgreen">userId</span>    | CK, FK                                   |                                                                                                                                                                                                          |
| Избранные рецепты                                                                | <span style="color:yellow">recipeId</span>      | CK, FK                                   |                                                                                                                                                                                                          |
|                                                                                  | createdAt                                       | timestamp                                |                                                                                                                                                                                                          |
| **SelectedRecipeForCooking**                                                     | <span style="color:lightgreen">userId</span>    | CK, FK                                   |                                                                                                                                                                                                          |
| Рецепты для предстоящего приготовления. Записи создаются при создании чек-листа. | <span style="color:yellow">recipeId</span>      | CK, FK                                   |                                                                                                                                                                                                          |
| Данные рецепты можно "приготовить"                                               | selectedAt                                      | timestamp                                |                                                                                                                                                                                                          |
|                                                                                  | isCooked                                        | bool                                     | Приготовлен ли рецепт\*                                                                                                                                                                                  |
|                                                                                  | lastUpdatedAt                                   | timestamp                                |                                                                                                                                                                                                          |
| **RecipePullRequest**                                                            | <span style="color:lightgreen">creatorId</span> | CK, FK                                   |                                                                                                                                                                                                          |
| Запрос на добавление рецепта в официальный список                                | <span style="color:yellow">recipeId</span>      | CK, FK                                   |                                                                                                                                                                                                          |
|                                                                                  | status                                          | Status                                   | Статус (4)                                                                                                                                                                                               |
|                                                                                  | comment                                         | varchar                                  | Примечание от автора (пояснение проблемы)                                                                                                                                                                |
| **ProductPullRequest**                                                           | <span style="color:lightgreen">creatorId</span> | CK, FK                                   |                                                                                                                                                                                                          |
| Аналогично RecipePullRequest                                                     | <span style="color:pink">productId</span>       | CK, FK                                   |                                                                                                                                                                                                          |
|                                                                                  | status                                          | Status                                   |                                                                                                                                                                                                          |
|                                                                                  | comment                                         | varchar                                  | Примечание от автора (пояснение проблемы)                                                                                                                                                                |

-  Рассматривается возможность откатывать транзакцию.
-  В приложении есть возможность добавлять свои продукты и рецепты в базу.
   Однако, такие продукты и рецепты не будут подтверждены (галочка на имени
   продукта отсутствует) и будут показываться в поиске только после официальных.

## Перечисления

-  **Роли**
   -  Администратор
   -  Стандартный
   -  Бог
-  **Валюты**
   -  USD
   -  BYN
   -  RUB
-  **Типы блюда**
   -  Вегетарианские блюда
   -  Выпечка
   -  Гарниры
   -  Горячие блюда
   -  Горячие закуски
   -  Десерты
   -  Домашний фаст-фуд
   -  Завтраки
   -  Консервация
   -  На углях
   -  Напитки
   -  Салаты
   -  Соусы, пасты и заправки
   -  Супы и бульоны
   -  Тесто
   -  Хлеб
   -  Холодные закуски
   -  Шашлыки
   -  Другое
-  **Единицы измерения**
   -  Грамм
   -  Килограмм
   -  Штука
   -  Столовая ложка
   -  Чайная ложка
   -  Литр
   -  Миллилитр
   -  Щепотка
-  **Статус**
   -  Ожидание
   -  Отклонен
   -  Принят

**_CK_** - Составной ключ

# Flow

## Пользователь

<details><summary>Холодильник: (продукты отображаются карточками с информацией)</summary>

-  Просмотр продуктов
   -  При просмотре продукта, который ожидает подтверждения статуса
      "Официальный", картинка продукта не отображается
   -  У неофициальных продуктов иконка **no photo**
   -  указание автора
-  Удаление продуктов из списка
-  Поиск
-  Добавление продуктов из общей базы
-  Кнопка для навигации на Мои продукты (1)
-  Нажатие на карточку продукта:
   -  Изменение количества \*
   -  Указание срока годности для количества продукта \*
-  Дополнительно - Карточка продукта с указанным сроком годности изменяет свой
цвет границ - Желтый за 6 дней до окончания срока - Красный за 2 дня до
окончания срока - Темный после срока годности - Отображение галочки
"Официальный" если продукт подтвержден администраторами - Если удален, то
помечается состоянием "удален". В поиске не предлагается
</details>
<details><summary>Рецепты: (рецепты отображаются карточками с информацией)</summary>

-  Просмотр рецептов
   -  При просмотре рецепта, который ожидает подтверждения статуса
      "Официальный", картинка рецепта не отображается
   -  У неофициальных рецептов иконка **no photo**
   -  указание автора
-  Поиск
-  Кнопка для навигации на Мои рецепты (2)
-  Нажатие на карточку рецепта:
   -  Просмотр информации о рецепте (фото, описание...)
   -  Кнопка добавления в избранное
-  Дополнительно - На карточка есть чекбокс, который отвечает за выбор рецепта
для приготовления - При выборе одного и более рецепта появляется кнопка
"добавить", которая добавляет рецепты в раздел для дальнейшего приготовления -
При добавлении рецепта в раздел "Для приготовления" недостающие продукты
автоматически добавляются в чек-лист. Пользователь получает уведомление. -
Отображение галочки "Официальный" если рецепт подтвержден администраторами -
Если удален, то помечается состоянием "удален". В поиске не предлагается
<details><summary>Избранные рецепты: (Дополнительная вкладка)</summary>

-  Всё аналогично рецептам, но отображаются только избранные пользователем
</details>
</details>
<details><summary> Мои продукты: (1)</summary>

-  Просмотр созданных продуктов
-  Удаление созданных продуктов
   -  Показать предупреждение о неполном удалении \*
-  Добавление своего продукта:
   -  Рамка для добавления фотографии продукта (только 1 фото)
      -  Отправка запроса на создание официального продукта невозможна без
         фотографии
   -  Поля для указания информации (Таблица Product)
   -  Чекбокс приватности (по-умолчанию приватно)
   -  Кнопка для отправки/отмены запроса на проверку (официальный рецепт).
      -  Отменить можно только если статус PENDING
-  Изменение информации о продукте - Изменения продукта после становления
официальным может производиться только через администраторов
</details>

<details><summary> Мои рецепты: (2)</summary>

-  Просмотр созданных рецептов
-  Удаление созданных рецептов
   -  Показать предупреждение о неполном удалении \*
-  Добавление своего рецепта:
   -  Рамка для добавления фотографии рецепта (только 1 фото)
      -  Отправка запроса на создание официального рецепта невозможна без
         фотографии
   -  Поля для указания информации (Таблица Recipe)
   -  Чекбокс приватности (по-умолчанию приватно)
   -  Кнопка для отправки/отмены запроса на проверку (официальный рецепт).
      -  Отменить можно только если статус PENDING
   -  Если у рецепта статус PENDING, то отправить повторно его нельзя (валидация
      на сервере).
-  Изменение информации о рецепте - Изменения рецепта после становления
официальным может производиться только через администраторов
</details>
<details><summary> Чек-листы:</summary>

-  Просмотр списков покупок, сортированных по датам (самые свежие вверху)
-  Подтверждение покупок (продукты переносятся в холодильник)
-  Отмена покупок (продукты вычитаются из холодильника)
   -  Отменить можно только листы, срок которых не больше дня
   -  Если при отмене списка продукта нет в холодильнике, то продукт
      пропускается
-  Можно сделать копию листа
-  Нажатие на карточку рецепта:
   -  Вывод списка продуктов в чек-листе
      -  Список можно редактировать, если продукты ещё не куплены. Иначе нельзя

</details>   
<details><summary> Рецепты, выбранные для приготовления:</summary>

-  Просмотр карточек
-  Нажатие:
   -  Выводится информация о рецепте
-  Подтверждение приготовления (продукты вычитаются из холодильника)
   -  Если продуктов недостаточно, то рецепт нельзя приготовить
-  Отмена приготовления (продукты прибавляются из холодильника)
   -  Отменить можно только рецепт, дата приготовления которого не больше дня от
   текущего
   </details>

## Менеджер

-  Пользователи
   -  Удаление
   -  Добавление
   -  Редактирование
   -  Дополнительно
      -  Администратору запрещено редактировать профили других администраторов
-  Продукты
   -  Удаление
   -  Добавление
   -  Редактирование
-  Рецепты
   -  Добавление
   -  Удаление
   -  Редактирование
-  Запросы на добавление в официальную базу
   -  Подтверждение рецепта
   -  Отклонение
   -  Комментирование

## Бог (админ)

-  То же, что и администратор, но с возможностью редактировать профили
   менеджеров
